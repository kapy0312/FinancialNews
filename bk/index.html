<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>è²¡ç¶“æ–°èæ•´åˆ</title>
  <style>
    body { font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; margin: 16px; }
    h1 { font-size: 20px; margin-bottom: 8px; }
    .controls { margin-bottom: 12px; display: flex; gap: 8px; align-items: center; }
    select, button { padding: 4px 8px; }
    .news-item { margin-bottom: 8px; padding: 6px 8px; border-bottom: 1px solid #ddd; }
    .news-meta { font-size: 12px; color: #666; }
    .source-tag { font-size: 12px; padding: 2px 6px; border-radius: 4px; background: #eee; margin-right: 6px; }
  </style>
</head>
<body>
  <h1>è²¡ç¶“æ–°èæ•´åˆ</h1>

  <div class="controls">
    <button id="refreshBtn">é‡æ–°æ•´ç†</button>
    <span id="status"></span>
    <label>
      ä¾†æºï¼š
      <select id="sourceFilter">
        <option value="">å…¨éƒ¨</option>
        <option value="ltn">è‡ªç”±è²¡ç¶“</option>
        <option value="udn">è¯åˆè²¡ç¶“</option>
        <option value="apple">è˜‹æœè²¡ç¶“</option>
        <option value="yahoo">Yahoo è²¡ç¶“</option>
        <option value="ettoday">ETtoday è²¡ç¶“</option>
        <option value="cna">ä¸­å¤®ç¤¾è²¡ç¶“</option>
        <option value="pts">å…¬è¦–è²¡ç¶“</option>
        <option value="udn_rss">ç¶“æ¿Ÿæ—¥å ± RSS</option>
      </select>
    </label>
  </div>

  <div id="newsContainer"></div>

  <script>
    // ğŸ‘‰ æ›æˆä½ çœŸæ­£éƒ¨ç½²çš„ /exec URL
    const API_URL = 'https://script.googleusercontent.com/macros/echo?user_content_key=AehSKLjZQ6oQMdq7HsQGI64QXborYcQehlmupFOjKN2mEeTPEUOk8M4-LXoIh4sq_vNjUjM9zyJZyrbl-WthmN6EkqyjSRrY3ZZnVCiEpT7gh5I4Vda5SaNaOraR7rQkBf5SqxIo3K23Phd2tv-XV2LZvjNEpWPUtnwrDWxGcHbsD7uvcTTakA97OVR44sGLq8IuSRmdaANV5fl79a38Gv94-ms1_JR2-6aL7HHXkbQlkxdXXV0rrQpRHD0WRm3n5yIHkIawnm681wSPavwKunDBr_mpTnDkwjnPm1p7u0hm&lib=MOt4wOVen3602dkcWEAfZZnK1hFUHtFm3';

    const newsContainer = document.getElementById('newsContainer');
    const statusEl = document.getElementById('status');
    const sourceFilter = document.getElementById('sourceFilter');
    const refreshBtn = document.getElementById('refreshBtn');

    let allNews = [];

    async function fetchNews() {
      statusEl.textContent = 'è¼‰å…¥ä¸­...';
      newsContainer.innerHTML = '';

      try {
        const res = await fetch(API_URL);
        if (!res.ok) throw new Error('HTTP ' + res.status);
        const data = await res.json();

        allNews = data.news || [];
        statusEl.textContent = `å…± ${allNews.length} å‰‡æ–°è`;
        renderNews();
      } catch (err) {
        console.error(err);
        statusEl.textContent = 'è¼‰å…¥å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦';
      }
    }

    function renderNews() {
      const filter = sourceFilter.value;
      const list = filter ? allNews.filter(n => n.source === filter) : allNews;

      newsContainer.innerHTML = '';

      list.forEach(item => {
        const div = document.createElement('div');
        div.className = 'news-item';

        // æœ‰äº› link æ˜¯ç›¸å°è·¯å¾‘ï¼ˆä¾‹å¦‚ Yahooï¼‰ï¼Œé€™è£¡å¯ä»¥å†åšä¸€æ¬¡ç°¡å–®è£œå…¨
        let link = item.link;
        if (link && link.startsWith('/')) {
          if (item.source === 'yahoo') {
            link = 'https://tw.stock.yahoo.com' + link;
          } else if (item.source === 'udn') {
            link = 'https://udn.com' + link;
          }
        }

        div.innerHTML = `
          <div>
            <span class="source-tag">${item.sourceName}</span>
            <a href="${link}" target="_blank" rel="noopener noreferrer">
              ${item.title}
            </a>
          </div>
          <div class="news-meta">
            æŠ“å–æ™‚é–“ï¼š${item.timestamp}
            ${item.rawTime ? `ï½œåŸå§‹æ™‚é–“ï¼š${item.rawTime}` : ''}
          </div>
        `;
        newsContainer.appendChild(div);
      });
    }

    // äº‹ä»¶ç¶å®š
    refreshBtn.addEventListener('click', fetchNews);
    sourceFilter.addEventListener('change', renderNews);

    // é é¢è¼‰å…¥æ™‚è‡ªå‹•æ’ˆä¸€æ¬¡
    fetchNews();
  </script>
</body>
</html>
